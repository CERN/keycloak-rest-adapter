variables:

  KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
  KEYCLOAK_REST_ADAPTER_CLIENT_SECRET: ${KEYCLOAK_REST_ADAPTER_CLIENT_SECRET}
  NAMESPACE_DEV: test-keycloak-rest-adapter
  NAMESPACE_QA: keycloak-rest-adapter-qa
  NAMESPACE_PROD: keycloak-rest-adapter
  OPENSHIFT_SERVER_PROD: https://openshift.cern.ch
  OPENSHIFT_SERVER_DEV: https://openshift-dev.cern.ch
  BUILD_ENV_DEV: staging
  BUILD_ENV_PROD: production
  BUILD_ENV_QA: qa
  QA_TAG: qa
  DEV_TAG: dev
  RESOURCE: ${CI_PROJECT_NAME}
  APP_NAME: ${CI_PROJECT_NAME}

stages:
  - build_docker
  - test
  - deploy

.docker_build_template: &docker_definition
  stage: build_docker
  tags:
    - docker-image-build
  script: "echo building $CI_REGISTRY_IMAGE for keycloak-rest-adapter" # No empty scripts are allowed

.deploy_template: &deploy_definition
  stage: deploy
  image: gitlab-registry.cern.ch/paas-tools/openshift-client:latest
  script:
    - LOWERCASE_PATH=$(echo ${CI_PROJECT_PATH} | awk '{ print tolower($0) } ')
    # Adding || true to disable the error message when the image already exists
    - oc import-image ${APP_NAME} --from="gitlab-registry.cern.ch/${LOWERCASE_PATH}:${TAG}" --confirm --token=${TOKEN} --server=${OPENSHIFT_SERVER} -n ${NAMESPACE} || true 
    - oc process --local -f openshift/adapter_configmap_${ENVIRONMENT}.yaml -p KEYCLOAK_ADMIN_PASSWORD=$KEYCLOAK_ADMIN_PASSWORD -p KEYCLOAK_REST_ADAPTER_CLIENT_SECRET=$KEYCLOAK_REST_ADAPTER_CLIENT_SECRET | oc replace -f - --token=${TOKEN} --server=${OPENSHIFT_SERVER} -n ${NAMESPACE}
    - oc tag --reference-policy=local --source=docker ${CI_REGISTRY_IMAGE}:${TAG} ${RESOURCE}:${TAG} --token=${TOKEN} --server=${OPENSHIFT_SERVER} -n ${NAMESPACE}

build_docker_dev:
  <<: *docker_definition
  variables:
    TO: ${CI_REGISTRY_IMAGE}:${DEV_TAG}
  only:
    - dev
    
build_docker_qa:
  <<: *docker_definition
  variables:
    TO: ${CI_REGISTRY_IMAGE}:${QA_TAG}
  only:
    - master

build_docker_prod:
  <<: *docker_definition
  variables:
    TO: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
  only:
    - tags # the branch you want to publish

test:
  stage: test
  script:
    - 'echo "Tests not implemented..."'

deploy_dev:
  <<: *deploy_definition
  variables:
    ENVIRONMENT: dev
    TOKEN: ${OPENSHIFT_DEV_TOKEN}
    OPENSHIFT_SERVER: ${OPENSHIFT_SERVER_DEV}
    NAMESPACE: ${NAMESPACE_DEV}
    TAG: ${DEV_TAG}
  environment:
    name: staging
    url: https://test-keycloak-rest-adapter.web.cern.ch
  only:
    - dev

deploy_qa:
  <<: *deploy_definition
  variables:
    ENVIRONMENT: qa
    TOKEN: ${OPENSHIFT_QA_TOKEN}
    OPENSHIFT_SERVER: ${OPENSHIFT_SERVER_PROD}
    NAMESPACE: ${NAMESPACE_QA}
    TAG: ${QA_TAG}
  environment:
    name: qa
    url: https://keycloak-rest-adapter-qa.web.cern.ch
  only:
    - master

deploy_prod:
  <<: *deploy_definition
  variables:
    ENVIRONMENT: prod
    TOKEN: ${OPENSHIFT_PROD_TOKEN}
    OPENSHIFT_SERVER: ${OPENSHIFT_SERVER_PROD}
    NAMESPACE: ${NAMESPACE_PROD}
    TAG: ${CI_COMMIT_TAG}
  environment:
    name: production
    url: https://keycloak-rest-adapter.web.cern.ch
  only:
    - tags
